<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>51Degrees API Documentation: Automatic Data File Updates</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="examplegrabber.js"></script>
<script type="text/javascript" src="search51.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="docs-main.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="l-docs-index p-doxygen">
<div class="l-index__content">
<!--div id="top"--><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" class="g-header g-header--docs">
  <h1 class="c-brand">
  <a id="projectlogo" href="index.html" class="c-brand__link"><img class="c-brand__image" alt="Logo" src="logo-51Degrees-Docs.png" style="width:172px;"/></a>
  <span class="c-tagline">51Degrees API Documentation
   &#160;<span id="projectnumber">4.4</span>
  </span>
  </h1>
  <div id="projectalign" style="padding-left: 0.5em;">
  </div>
  <div id="main-nav"></div>
  <section class="g-search">
    <div class="c-search is-openable" id="searchOpenable">
    <form class="c-search__form">
      <div class="b-form-group b-form-group--with-icon">
        <label for="inputSearch" class="b-text--hidden">Search</label>
        <img src="icon-search.svg" class="b-icon" alt="Search" />
        <input type="text" class="c-search__input" id="inputSearch" onkeyup="javascript:onSearch(this,event.keyCode)" placeholder="Search" aria-label="Search">
      </div>
    </form>
    <div class="c-search__content" id="searchContent">
    </div>
  </div> 
  </section>
</div>
<!-- end header part -->
<main class="g-main">
<!-- Generated by Doxygen 1.8.15 -->
<!-- top -->
	<div class="g-docs__sidenav">																														         <nav id="nav-tree-contents" class="c-sidenav">																														     <h4 class="c-sidenav__heading">Documentation</h4>																									         <div id="nav-sync" class="sync"></div>
  <ul class="c-sidenav__list">																														     </ul>																																				   </nav>    </div><script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_features__automatic_datafile_updates.html','');});
/* @license-end */
</script>
<div id="doc-content" class="g-docs__content">
<div class="PageDoc"><div class="g-docs__header">
<div class="c-breadcrumb">
  <ul class="c-breadcrumb">
<li class="c-breadcrumb__item"><a class="c-breadcrumb__link" href="_features__index.html">Features</a></li><li class="c-breadcrumb__item"><a class="c-breadcrumb__link" href="_features__automatic_datafile_updates.html">Automatic Data File Updates</a></li>  </ul>
</div>
<h2 class="g-docs__page-title">Automatic Data File Updates </h2></div><!--header-->
<div class="g-docs__inner">
<div class="g-docs__primary" id="primary">
<section class="g-docs__section"><h1 class="g-docs__section-heading">Introduction</h1>
<p><a class="el" href="_concepts__flow_elements__on_premise_engine.html">On-premise engines</a> added to a <a class="el" href="_concepts__pipeline.html">Pipeline</a> can have their data files registered for automatic updates. When there is a new version of a data file available, it will be downloaded and the <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> refreshed with it. The file location where the data file was loaded from can also be monitored for changes, so when a data file is manually replaced, the <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> will be refreshed with it.</p>
<p>This page describes the functionality and options for data updates in the pipeline API. In addition, it is worth being familiar with the <a class="el" href="_info__distributor.html">Distributor</a> web API, which supplies the updated data files.</p>
<h1 class="g-docs__section-heading">Registering for updates</h1>
<p>All data files added to an <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> have the option to enable <b>automatic updates</b>. By enabling this, the data file is automatically registered when the <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> is added to a <a class="el" href="_concepts__pipeline.html">Pipeline</a>.</p>
<p>A data file can also be manually registered for <b>automatic updates</b> by registering with the <a class="el" href="_features__automatic_datafile_updates.html">data update service</a>. This works in exactly the same way as if it was registered by the <a class="el" href="_concepts__configuration__builders__pipeline_builder.html">pipeline builder</a>, but in most cases is not necessary as the <a class="el" href="_concepts__configuration__builders__pipeline_builder.html">pipeline builder</a> will do this.</p>
<h1 class="g-docs__section-heading">Configuration</h1>
<p>There are a number of configuration options available when registering a data file for <b>automatic updates</b>, which specify when and how the data file is updated.</p>
<h2>Data update URL</h2>
<p>To download a new data file when one becomes available, the <a class="el" href="_features__automatic_datafile_updates.html">data update service</a> must have a URL to download it from. This can be a constant URL, or a <a class="el" href="_features__automatic_datafile_updates.html#Features_AutomaticDatafileUpdates_UrlFormatter">URL formatter</a> can be used to dynamically generate the URL based on other options.</p>
<h2>License Keys</h2>
<p>A License Key may be required when downloading certain types of data files. The <a class="el" href="_features__automatic_datafile_updates.html">data update service</a> uses the License Key, in combination with a <a class="el" href="_features__automatic_datafile_updates.html#Features_AutomaticDatafileUpdates_UrlFormatter">URL formatter</a>, to ensure the data file is only made available to licensed users.</p>
<h2>File watcher</h2>
<p>The location of the data file in the file system can be monitored by enabling the file system watcher. If the data file changes, then the <a class="el" href="_features__automatic_datafile_updates.html">data update service</a> will be called to refresh the <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> using that file. This can be useful when distributing data files to a local cluster.</p>
<h2>Polling interval</h2>
<p>The polling interval tells the <a class="el" href="_features__automatic_datafile_updates.html">data update service</a> the frequency with which to check for the availability of a new data file when the expected date is not known. If the data file itself provides the date when the next update is expected, then the <a class="el" href="_features__automatic_datafile_updates.html">data update service</a> will not check for updates at all until after that date is passed.</p>
<h2>Randomization</h2>
<p>In large clusters of servers, it is beneficial to stagger an update. If all servers download a new data file and refresh at the same time, a service's overall performance can be affected. To prevent this, the randomization option enables a random time interval to be added to the time at which the new data file is downloaded. For example, if there are 10 servers, and a full download and refresh takes around 10 seconds, it is sensible to set the randomization to above 10 seconds. In this case, there should only be one server updating at any one time.</p>
<h2>URL formatter<a class="anchor" id="Features_AutomaticDatafileUpdates_UrlFormatter"></a></h2>
<p>Where an <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> needs to download a data file from a URL which is not constant, a URL formatter is used. <a class="el" href="_concepts__flow_elements__on_premise_engine.html">On-premise engines</a> generally provide the correct URL formatter automatically, but the option to override this is available.</p>
<p>URL formatters are necessary in many cases where multiple data files are available for an <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a>. For example, the required format or version of the data file may need to be specified as a parameter in the URL. This is handled by the URL formatter by looking at the current data file to see what is needed.</p>
<h2>Temporary file</h2>
<p>It is good practice to set a data file to be copied to a temporary location for use by an <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a>. This means that whatever mode the file is being used in (e.g., in memory or streamed from file) an <b>update</b> can occur smoothly.</p>
<p>By setting the <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> to use a temporary file location, the original data file is free to be changed by the <b>autoupdateservice</b>. Once the file has been replaced, the <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> will be informed and manage the removal of the temporary file and creation of a new one.</p>
<h2>Decompression</h2>
<p>Data files are often served as GZipped content from their download URL to minimize the amount of data which needs to be downloaded. When this is the case, the <a class="el" href="_features__automatic_datafile_updates.html">data update service</a> will unzip the data file before carrying on with the process.</p>
<p>Usually an <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engine</a> will set this option, along with the URL/<a class="el" href="_features__automatic_datafile_updates.html#Features_AutomaticDatafileUpdates_UrlFormatter">URL formatter</a>. But if an alternative URL has been set, then this option may need to be overridden too.</p>
<h2>Verify MD5</h2>
<p>A server will often provide the MD5 hash of the data file which it has served in the <code>Content-MD5</code> response header. This can then be checked against that which was actually downloaded to ensure the integrity of the data file. By default this is usually enabled, however not all download servers support it.</p>
<h2>Verify 'If-Modified-Since'</h2>
<p>Unnecessary downloads can be prevented by providing the download server with an <code>If-Modified-Since</code> HTTP header. If this option is enabled (which it is by default for most <a class="el" href="_concepts__flow_elements__on_premise_engine.html">on-premise engines</a>) the <code>If-Modified-Since</code> header will be set to the date at which the current data file was last modified. If there is not a newer data file on the server then the service will not attempt to download a file.</p>
<p><a class="anchor" id="Large_Clusters"></a><a class="el" href="_features__automatic_datafile_updates.html#Large_Clusters">#</a> </p><h1 class="g-docs__section-heading">Recommendations for large clusters</h1>
<p>The <a class="el" href="_info__distributor.html">Distributor</a> API is limited in the number of requests it can service per day. This is enforced by each License Key being limited to a certain number of requests (max 100, although some Keys will have a lower threshold than this) in each 30-minute period.</p>
<p>Environments that use large numbers of independent nodes can easily exceed this threshold if the automatic update functionality provided by the pipeline API is switched on.</p>
<p>Instead, we recommend that a single machine (with secondaries as necessary for redundancy, etc.) is tasked with downloading the data file each day using curl or similar.</p>
<p>There are then several approaches for deploying the new data file within your environment:</p>
<h2>Shared network location</h2>
<p>The data file can be placed in a shared network location that is visible to many nodes. The pipeline can then be created using this shared file as the data file location.</p>
<p>If the ‘File System Watcher’ option (described in the sections above) is enabled in the API, it will watch the file for changes and refresh the API when it is updated. Where File System Watcher is not supported by the language, the pipeline will need to be re-created using the new data file.</p>
<p>This approach is very simple to implement, but bear in mind that there is no staggering of the update. When the nodes see the new file, they will all attempt to reload from it in a short space of time. This may cause too much infrastructure load.</p>
<p>This could be mitigated by using multiple shared locations that are updated in a staggered way from a single master copy of the data file. Alternatively, one of the approaches below gives you more control over when updates happen.</p>
<p>In addition, we would only recommend using this setup with the 'MaxPerformance' <a class="el" href="_device_detection__features__performance_options.html">performance option</a> enabled. Other options will stream data from the data file as needed, which will be relatively slow and bandwidth-heavy.</p>
<h2>Push data file to nodes</h2>
<p>You can use whatever tools are provided by your environment to push the new file out to the nodes in the cluster.</p>
<p>As above, the File System Watcher must be enabled in order for the API to notice the new data file and refresh its internal data structures.</p>
<h2>Self-hosted HTTP update</h2>
<p>If the data file is hosted and made available on a static URL that is accessible within your environment, the nodes can be configured to check this location for updates, instead of the Distributor service.</p>
<p>An example of how to configure a device detection engine in this scenario is shown below. You can also configure it in code using the relevant engine builder.</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">{</div><div class="c-code__line">  &quot;BuilderName&quot;: &quot;DeviceDetectionHashEngine&quot;,</div><div class="c-code__line">  &quot;BuildParameters&quot;: {</div><div class="c-code__line">    &quot;DataFile&quot;: &quot;data/TAC-HashV41.hash&quot;,</div><div class="c-code__line">    &quot;TempDirPath&quot;: &quot;data/tmp&quot;,</div><div class="c-code__line">    &quot;AutoUpdate&quot;: true,</div><div class="c-code__line">    &quot;DataUpdateOnStartup&quot;: true,</div><div class="c-code__line">    &quot;UpdatePollingInterval&quot;: 14400,</div><div class="c-code__line">    &quot;UpdateRandomisationMax&quot;: 600,</div><div class="c-code__line">    &quot;CreateTempDataCopy&quot;: true,</div><div class="c-code__line">    &quot;DataUpdateUrl&quot;: &quot;https://myhost.net/51Ddatafile&quot;,</div><div class="c-code__line">    &quot;DataUpdateVerifyMd5&quot;: false,</div><div class="c-code__line">    &quot;DataUpdateUseUrlFormatter&quot;: false,</div><div class="c-code__line">    &quot;DataUpdateLicenseKey&quot;: &quot;KEY&quot;</div><div class="c-code__line">  }</div><div class="c-code__line">}</div></div><p>The key settings for our purposes are:</p><ul>
<li><b>DataUpdateUrl</b> - The static URL to use when checking for a new data file.</li>
<li><b>DataUpdateVerifyMd5</b> - You can either configure your endpoint to also response with an MD5 HTTP Header, or set this to false to prevent it trying to verify the content.</li>
<li><b>DataUpdateUseUrlFormatter</b> - This must be set to false to prevent the API from appending the query string parameters that are required when calling the 51Degrees Distributor service.</li>
</ul>
<p>Be aware that the compute nodes will start checking the URL for updates as soon as the 'next published date', which is stored in the data file, is reached. This may be before a new data file is actually available from the static URL.</p>
<p>This means that you will probably need to configure your URL to accept and make use of the <code>If-Modified-Since</code> HTTP header to allow the API to check if it needs an update without downloading the entire data file.</p>
<p>See the <a class="el" href="_info__distributor.html">Distributor</a> documentation for details of how this works. </p>
</section></div><!-- PageDoc -->
</div><!-- primary -->
</div><!-- inner-->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<section id="nav-path" class="g-footer g-footer--docs"><!-- id is needed for treeview function! -->
    <p class="g-footer__copyright">Generated by
    <a href="http://www.doxygen.org/index.html">
    <b>doxygen</b></a> 1.8.15
  </p>
</section>
</div>
</main>
</div>
</body>
</html>
