<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>51Degrees API Documentation: Nginx</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="examplegrabber.js"></script>
<script type="text/javascript" src="testedversionsgrabber.js"></script>
<script type="text/javascript" src="search51.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="docs-main.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="l-docs-index p-doxygen">
<div class="l-index__content">
<!--div id="top"--><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" class="g-header g-header--docs">
  <h1 class="c-brand">
  <a id="projectlogo" href="index.html" class="c-brand__link"><img class="c-brand__image" alt="Logo" src="logo-51Degrees-Docs.png" style="width:172px;"/></a>
  <span class="c-tagline">51Degrees API Documentation
   &#160;<span id="projectnumber">4.4</span>
  </span>
  </h1>
  <div id="projectalign" style="padding-left: 0.5em;">
  </div>
  <div id="main-nav"></div>
  <section class="g-search">
    <div class="c-search is-openable" id="searchOpenable">
    <form class="c-search__form">
      <div class="b-form-group b-form-group--with-icon">
        <label for="inputSearch" class="b-text--hidden">Search</label>
        <img src="icon-search.svg" class="b-icon" alt="Search" />
        <input type="text" class="c-search__input" id="inputSearch" onkeyup="javascript:onSearch(this,event.keyCode)" placeholder="Search" aria-label="Search">
      </div>
    </form>
    <div class="c-search__content" id="searchContent">
    </div>
  </div> 
  </section>
</div>
<!-- end header part -->
<main class="g-main">
<!-- Generated by Doxygen 1.8.15 -->
<!-- top -->
	<div class="g-docs__sidenav">																														         <nav id="nav-tree-contents" class="c-sidenav">																														     <h4 class="c-sidenav__heading">Documentation</h4>																									         <div id="nav-sync" class="sync"></div>
  <ul class="c-sidenav__list">																														     </ul>																																				   </nav>    </div><script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_other_integrations__nginx.html','');});
/* @license-end */
</script>
<div id="doc-content" class="g-docs__content">
<div class="PageDoc"><div class="g-docs__header">
<div class="c-breadcrumb">
  <ul class="c-breadcrumb">
<li class="c-breadcrumb__item"><a class="c-breadcrumb__link" href="_other_integrations__index.html">Other Integrations</a></li><li class="c-breadcrumb__item"><a class="c-breadcrumb__link" href="_other_integrations__nginx.html">Nginx</a></li>  </ul>
</div>
<h2 class="g-docs__page-title">Nginx </h2></div><!--header-->
<div class="g-docs__inner">
<div class="g-docs__primary" id="primary">
<section class="g-docs__section"><h1 class="g-docs__section-heading">Introduction</h1>
<p>We have also integrated our Device Detection to Nginx. This page describes in detail how you can install and use our module in your Nginx environment. </p><h1 class="g-docs__section-heading">Prerequisites</h1>
<h2>Dependencies:</h2>
<ul>
<li>gcc</li>
<li>make</li>
<li>zlib1g-dev</li>
<li>libpcre3</li>
<li>libpcre3-dev</li>
</ul>
<h2>Tested versions:</h2>
<ul>
<li>Nginx 1.21.3, 1.20.0, 1.19.0, 1.19.5, 1.19.10</li>
<li>C11 or above</li>
</ul>
<h2>Tested platforms:</h2>
<ul>
<li>Ubuntu 18.04</li>
<li>Ubuntu 20.04</li>
</ul>
<h2>Tested architectures:</h2>
<ul>
<li>64-bit</li>
</ul>
<h1 class="g-docs__section-heading">Installing</h1>
<p>If you havenâ€™t already, you can obtain a copy of the latest version of the API <a href="https://github.com/51Degrees/device-detection-nginx">here</a>.</p>
<p>To build the module only, run the following command. This will output to <code>ngx_http_51D_module.so</code> in the <code>build/modules</code> directory. </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">make module</div></div><p> <br />
</p>
<p>To build the module and Nginx, run the following command. </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">make install</div></div><p> By default, this will use the latest version of Nginx specified in the Makefile. To use a specific version of Nginx, run the above command with the <code>FIFTYONEDEGREES_NGINX_VERSION</code> variable. e.g., </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">make install FIFTYONEDEGREES_NGINX_VERSION=[Version]</div></div><p> <br />
</p>
<p>To build and link the module statically with Nginx, use the <code>STATIC_BUILD</code> variable. e.g., </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">make install STATIC_BUILD=1</div></div><p> <br />
</p>
<p>Finally, run the 51Degrees tests with the default 51Degrees Lite data file included in the <code>device-detection-cxx\device-detection-data</code> directory. Make sure to build the module with <code>make install</code> command as the tests do not work on a static build. </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">make test</div></div><p>To run the 51Degrees together with the Nginx test suite, run the following command: </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">make test-full</div></div><p>These do not run all the required tests as some tests require properties that are not supported with the Lite version of the data file. To run all tests, obtain a data file that provides properties: JavascriptHardwareProfile, ScreenPixelsWidthJavascript, and ScreenPixelsWidth. Then, use the <code>FIFTYONEDEGREES_DATAFILE</code> variable to specify the file name to run the tests with. The new data file should be placed in the <code>device-detection-cxx\device-detection-data</code> folder and should have a different name to <code>51Degrees-LiteV4.1.hash</code>. If tests still fail, obtain a data file with any other properties used in the tests. Below is an example of running tests with a different data file named <code>51Degrees-EnterpriseV4.1.hash</code>: </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">make [test|test-full] FIFTYONEDEGREES_DATAFILE=51Degrees-EnterpriseV4.1.hash</div></div><h1 class="g-docs__section-heading">Configuring the Nginx API</h1>
<p>Before you start performing any detections, you may wish to configure the detection.</p>
<h2>Init Settings</h2>
<p>Detection configuration directives.</p>
<div class="g-table g-table--overflow"><table class="c-table">
<tr class="c-table__row--heading">
<td class="c-table__cell">Directives   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_file_path</code> <em>filename</em>;<br />
Default: &mdash;<br />
Context: main<br />
Specify the data file to used for 51Degrees Device Detection V4 engine   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_drift</code> <em>drift</em>;<br />
Default: 51D_drift 0;<br />
Context: main<br />
Specify the <code>drift</code> value that a detection can allow. Details about how setting <code>drift</code> value effects the results can be found at <a class="el" href="_device_detection__features__false_positive_control.html">False Positive</a>.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_difference</code> <em>difference</em>;<br />
Default: 51D_difference 0;<br />
Context: main<br />
Specify the <code>difference</code> value that a detection can allow. Details about how setting <code>difference</code> value effects the results can be found at <a class="el" href="_device_detection__features__false_positive_control.html">False Positive</a>.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_allow_unmatched</code> <em>on | off</em>;<br />
Default: 51D_allow_unmatched off;<br />
Context: main<br />
Specify if <code>AllowUnmatched</code> should be allowed. Details about how setting <code>AllowUnmatched</code> value effects the results can be found at <a class="el" href="_device_detection__features__false_positive_control.html">False Positive</a>.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_use_performance_graph</code> <em>on | off</em>;<br />
Default: 51D_use_performance_graph off;<br />
Context: main<br />
Specify if performance graph should be used in detection. More details about <code>performance graph</code> can be found at <a class="el" href="_device_detection__hash.html">Hash</a>.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_use_predictive_graph</code> <em>on | off</em>;<br />
Default: 51D_use_predictive_graph on;<br />
Context: main<br />
Specify if predictive graph should be used in detection. More details about <code>predictive graph</code> can be found at <a class="el" href="_device_detection__hash.html">Hash</a>.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_value_separator</code> <em>separator</em>;<br />
Default: 51D_value_separator ',';<br />
Context: main<br />
Specify the separator to be used in the value string returned from a detection. Each value in the returned result string corresponds to a requested property.   </td></tr>
</table>
</div> <h2>Match settings</h2>
<p>Match directives.</p>
<div class="g-table g-table--overflow"><table class="c-table">
<tr class="c-table__row--heading">
<td class="c-table__cell">Directives   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_match_single</code> <em>header</em> <em>properties</em> [<em>argument</em>];<br />
Default: &mdash;<br />
Context: main, server, <code>location</code> (<b>NOTE</b>: This directive can be used in main, server and location blocks. Specified properties are aggregated and eventually queried in the location. <em>header</em> value is set after the query is performed and is only available within <code>location</code> block)<br />
Perform a detection using a single request header <code>User-Agent</code>. <em>header</em> specifies which request header the returned <em>properties</em> values should be stored at. <em>properties</em> is a comma separated list string. <em>argument</em> specifies if <code>User-Agent</code> is supplied as a query argument. This will override the value in the <code>User-Agent</code> header. The <em>argument</em> is optional.<br />
If a property is not available for any reason, the value being returned for that property will be <code>NA</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_match_all</code> <em>header</em> <em>properties</em>;<br />
Default: &mdash;<br />
Context: main, server, <code>location</code> (<b>NOTE</b>: This directive can be used in main, server and location blocks. Specified properties are aggregated and eventually queried in the location. <em>header</em> value is set after the query is performed and is only available within <code>location</code> block)<br />
Perform a detection using all headers, query argument and cookie from a http request. <em>header</em> specifies which request header the returned <em>properties</em> values should be stored at. <em>properties</em> is a comma separated list string.<br />
If a property is not available for any reason, the value being returned for that property will be <code>NA</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_get_javascript_single</code> <em>javascript_property</em> [<em>argument</em>];<br />
Default: &mdash;<br />
Context: location<br />
Perform a detection using a single request header <code>User-Agent</code>. The returned value of <em>javascript_property</em> is set in the response body. This works in a similar way as CDN to serve static content. <em>argument</em> specifies if <code>User-Agent</code> is supplied as a query argument. This will override the value in the <code>User-Agent</code> header. The <em>argument</em> is optional.<br />
If the Javascript property is not available for any reason, a Javascript block comment will be returned so that it will not cause syntax error when the client s it.<br />
The whole response body is used for the returned content so only one of these directives can be used in a single location block. Also, since the static content does not actually exist as a static file, the nginx http core module will log an error, so it is recommended to use this directive with <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#log_not_found">log_not_found</a> set to off.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_get_javascript_all</code> <em>javascript_property</em>;<br />
Default: &mdash;<br />
Context: location<br />
Perform a detection using all headers, cookie and query arguments from a http request. The returned value of <em>javascript_property</em> is set in the response body. This works in a similar way as CDN to serve static content.<br />
If the Javascript property is not available for any reason, a Javascript block comment will be returned so that it will not cause syntax error when the client executes it.<br />
The whole response body is used for the returned content so only one of these directives can be used in a single location block. Also, since the static content does not actually exist as a static file, the nginx http core module will log an error, so it is recommended to use this directive with <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#log_not_found">log_not_found</a> set to off.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">Syntax: <code>51D_set_resp_headers</code> <em>on | off</em>;<br />
Default: 51D_set_resp_headers off<br />
Context: main, server, location<br />
Allow Client Hints to be set in response headers where it is applicable to the user agent (e.g. Chrome 89 or above) so that more evidence can be returned in subsequent requests, allowing more accurate detection. Value set in a block overwrites values set in precedent blocks (e.g. value set in <code>location</code> block will overwrite value set in <code>server</code> and <code>main</code> blocks). This will only be available from the 4.3.0 version onwards.   </td></tr>
</table>
</div><h1 class="g-docs__section-heading">New features</h1>
<p>Following set of new features has been introduced in Nginx Device Detection V4 module:</p><ul>
<li>Detection match metrics</li>
<li>Javascript and property overrides</li>
<li>False Positive controls</li>
<li>User-Agent Client Hint supports</li>
</ul>
<h2>Detection match metrics</h2>
<p>This V3 functionality is extended with more options available in V4. These metrics can be used in the same way as the properties. </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">51D_match_all x-metrics IsMobile,Iterations,Drift,Difference,Method,UserAgents,MatchedNodes,DeviceId;</div></div><h2>Javascript and property overrides</h2>
<p>Some certain properties might require further steps to obtain. For example, to determine ScreenPixelsWidth, users might need to execute the Javascript returned from ScreenPixelsWidthJavascript property in client User-Agents. In V4, we allow users to request the Javascript as static content via using <code>51D_get_javascript_single</code> and <code>51D_get_javascript_all</code> directives.</p>
<p>Once the value has been obtained by executing the Javascript in client user agent, it can be added as evidence in the next request's cookie or query argument. 51Degrees module will override the returned value with what it found in the request.</p>
<h2>False Positive Controls</h2>
<p>Nginx Device Detection V4 module supports <code>False Positives</code> features as described at <a class="el" href="_device_detection__features__false_positive_control.html">False Positives</a> via settings of directives <code>51D_drift</code>, <code>51D_difference</code>, and <code>51D_allow_unmatched</code>. When <code>AllowUnmatched</code> is set to <code>off</code>, if <code>HasValue</code> is <code>false</code>, a <code>NoMatch</code> will be returned. Else, if <code>AllowUnmatched</code> is set to <code>on</code>, when a match can not be found, default profile will be returned such as <code>Unknown</code>, <code>N/A</code>, or similar.</p>
<h2>User-Agent Client Hint supports</h2>
<p>User-Agent Client Hint was introduced by Google in Chrome, preventing traditional detection using User-Agents from performing accurate matches. In Nginx Device Detection V4 module, <code>51D_set_resp_headers</code> was implemented to allow Client Hint request headers to be set in responses so that more evidence is provided in subsequent requests, allowing better matches.</p>
<h1 class="g-docs__section-heading">Other resources</h1>
<p>More details can be found at:</p><ul>
<li><a href="https://51degrees.com/device-detection-nginx/md__home_vsts_work_1_s_apis_device-detection-nginx__r_e_a_d_m_e.html">README</a>.</li>
<li><a href="https://51degrees.com/device-detection-nginx/examples.html">Examples</a></li>
<li><a class="el" href="_device_detection__migration_guides_51_degrees_v3.html">Migrations</a> </li>
</ul>
</section></div><!-- PageDoc -->
</div><!-- primary -->
</div><!-- inner-->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<section id="nav-path" class="g-footer g-footer--docs"><!-- id is needed for treeview function! -->
    <p class="g-footer__copyright">Generated by
    <a href="http://www.doxygen.org/index.html">
    <b>doxygen</b></a> 1.8.15
  </p>
</section>
</div>
</main>
</div>
</body>
</html>
