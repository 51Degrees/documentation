<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>51Degrees API Documentation: Usage Sharing Feature</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="examplegrabber.js"></script>
<script type="text/javascript" src="testedversionsgrabber.js"></script>
<script type="text/javascript" src="search51.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="docs-main.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="l-docs-index p-doxygen">
<div class="l-index__content">
<!--div id="top"--><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" class="g-header g-header--docs">
  <h1 class="c-brand">
  <a id="projectlogo" href="index.html" class="c-brand__link"><img class="c-brand__image" alt="Logo" src="logo-51Degrees-Docs.png" style="width:172px;"/></a>
  <span class="c-tagline">51Degrees API Documentation
   &#160;<span id="projectnumber">4.5</span>
  </span>
  </h1>
  <div id="projectalign" style="padding-left: 0.5em;">
  </div>
  <div id="main-nav"></div>
  <section class="g-search">
    <div class="c-search is-openable" id="searchOpenable">
    <form class="c-search__form">
      <div class="b-form-group b-form-group--with-icon">
        <label for="inputSearch" class="b-text--hidden">Search</label>
        <img src="icon-search.svg" class="b-icon" alt="Search" />
        <input type="text" class="c-search__input" id="inputSearch" onkeyup="javascript:onSearch(this,event.keyCode)" placeholder="Search" aria-label="Search">
      </div>
    </form>
    <div class="c-search__content" id="searchContent">
    </div>
  </div> 
  </section>
</div>
<!-- end header part -->
<main class="g-main">
<!-- Generated by Doxygen 1.8.15 -->
<!-- top -->
	<div class="g-docs__sidenav">																														         <nav id="nav-tree-contents" class="c-sidenav">																														     <h4 class="c-sidenav__heading">Documentation</h4>																									         <div id="nav-sync" class="sync"></div>
  <ul class="c-sidenav__list">																														     </ul>																																				   </nav>    </div><script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_features__usage_sharing.html','');});
/* @license-end */
</script>
<div id="doc-content" class="g-docs__content">
<div class="PageDoc"><div class="g-docs__header">
<div class="c-breadcrumb">
  <ul class="c-breadcrumb">
<li class="c-breadcrumb__item"><a class="c-breadcrumb__link" href="_features__index.html">API Features</a></li><li class="c-breadcrumb__item"><a class="c-breadcrumb__link" href="_features__usage_sharing.html">Usage Sharing Feature</a></li>  </ul>
</div>
<h2 class="g-docs__page-title">Usage Sharing Feature </h2></div><!--header-->
<div class="g-docs__inner">
<div class="g-docs__primary" id="primary">
<section class="g-docs__section"><h1 class="g-docs__section-heading">Introduction</h1>
<p>Some of the services offered by 51Degrees benefit from <a class="el" href="_concepts__data__evidence.html">evidence</a> (optionally) being sent back to 51Degrees data processing system from live installations of the <a class="el" href="_concepts__pipeline.html">Pipeline</a>. We use this evidence to ensure that our data is up-to-date, comprehensive, and continues to provide accurate results.</p>
<p>A specific set of evidence must be seen a number of times, from a number of sources to be deemed reliable enough to contribute to the data file.</p>
<p>See the <a href="https://github.com/51Degrees/specifications/blob/main/pipeline-specification/features/usage-sharing.md#">Specification</a> for more technical details.</p>
<p><div class="dotgraph">
<iframe scrolling="no" frameborder="0" src="dot_usagesharing.svg" width="503" height="328"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</p>
<h1 class="g-docs__section-heading">How to enable usage sharing</h1>
<p><b>Usage sharing</b> is enabled by default if you are using a pipeline builder that is derived from a 51Degrees pipeline builder (for example, DeviceDetetctionPipelineBuilder or FiftyOnePipelineBuilder). To configure the <b>usage sharing</b> feature, please refer to our <a class="el" href="_examples__usage_sharing.html">Usage Sharing Examples</a>.</p>
<p>To enable <b>usage sharing</b> for low-level APIs such as C, Nginx, and Varnish, please refer to the <a class="el" href="_features__usage_sharing.html#Low_Level_Usage_Sharing">Usage Sharing for low-level APIs section</a> further down this page.</p>
<p>Please refer to the <a class="el" href="_examples__usage_sharing.html">Usage Sharing Examples</a> section to check if <b>user sharing</b> is implemented for a particular language or API. To request an additional implementation of this feature, please <a href="https://51degrees.com/contact-us">get in touch</a>.</p>
<p>If you have any questions on how we use the data you share with us via usage sharing, please refer to our blog <a href="https://51degrees.com/blog/usage-sharing-how-do-we-use-your-data">Usage sharing: how do we use your data</a>.</p>
<p><a class="anchor" id="Internals"></a><a class="el" href="_features__usage_sharing.html#Internals">#</a> </p><h1 class="g-docs__section-heading">Internals</h1>
<p>To minimize any overhead of this feature, received requests are grouped and sent in batches, rather than sending each request individually.</p>
<p><b>Usage sharing</b> is designed such that any failure within it should not impact the result of the <a class="el" href="_concepts__pipeline.html">Pipeline</a>. If a failure does occur then <b>usage sharing</b> will simply be disabled and an appropriate warning logged.</p>
<p>In languages that support multiple threading, <b>Usage sharing</b> will typically use a producer/consumer model, where the 'main' thread adds the evidence to a queue while a background thread takes items from this queue, transforms them into the appropriate format, adds them into a message, and sends the message when ready. This is done to avoid blocking the <a class="el" href="_concepts__pipeline.html">Pipeline</a> process thread.</p>
<p><a class="anchor" id="RepeatEvidence"></a><a class="el" href="_features__usage_sharing.html#RepeatEvidence">#</a> </p><h2>Repeated evidence</h2>
<p>To avoid situations where the same <a class="el" href="_concepts__data__evidence.html">evidence</a> is sent multiple times (for example, a single user visiting multiple pages on a website), we keep track of the <a class="el" href="_concepts__data__evidence.html">evidence</a> that has been shared over a defined time period (maximum 20 minutes by default) and only share <a class="el" href="_concepts__data__evidence.html">evidence</a> which is different to any already shared during the window.</p>
<p>Note that the amount of <a class="el" href="_concepts__data__evidence.html">evidence</a> tracked is also constrained based upon available memory. In high-traffic scenarios, this may mean that the time period covered by the <a class="el" href="_concepts__data__evidence.html">evidence</a> in the tracker is much smaller than the configured maximum.</p>
<h1 class="g-docs__section-heading">Configuration</h1>
<p>The <b>usage sharing</b> feature is provided by a <a class="el" href="_concepts__flow_elements__flow_element.html">flow element</a> that is added to the <a class="el" href="_concepts__pipeline.html">Pipeline</a>. Certain <a class="el" href="_concepts__configuration__builders__pipeline_builder.html">pipeline builders</a> will do this automatically. For example, the <a class="el" href="_device_detection__overview.html">device detection</a> <a class="el" href="_concepts__configuration__builders__pipeline_builder.html">pipeline builder</a> will add the <b>usage sharing</b> element by default. This can be disabled using the SetShareUsage method on the builder.</p>
<p>There are also several configuration options when building a <b>usage sharing</b> element. These can be used to control what is shared and how it is collected:</p>
<h2>Evidence shared</h2>
<p>The <b>usage sharing</b> element will not be interested in all <a class="el" href="_concepts__data__evidence.html">evidence</a> in the <a class="el" href="_concepts__data__flow_data.html">flow data</a>. These are the rules for whether or not a particular piece of evidence is shared:</p>
<ul>
<li>Any evidence named 'header.&lt;name&gt;', if &lt;name&gt; is <b>not</b> on a configured blocklist.</li>
<li>Any evidence named 'query.&lt;name&gt;', if &lt;name&gt; <b>is</b> on a configured allowlist.</li>
<li>Any evidence named 'cookie.&lt;name&gt;' is ignored, unless &lt;name&gt; starts with '51D_'.</li>
<li>Any other evidence is shared if it is not on a configured blocklist.</li>
</ul>
<p>The various blocklists and allowlists can be configured using the <b>share usage</b> <a class="el" href="_concepts__configuration__builders__element_builder.html">element builder</a>.</p>
<h3>Evidence detail</h3>
<p>Some of the values sent as evidence are more important for our backend processing than others. This section describes some of the most important, along with why they are useful to us. Any values marked with 'REQUIRED' must be included, or our backend systems will discard the data.</p>
<ul>
<li>server.client-ip - REQUIRED - The IP address of the client that is connecting to the website/service. This is useful in order for us to evaluate the quality of the data. For an over-simplified example, large numbers of requests coming from a single IP are more likely to be bot or test traffic with spoofed details, which we do not want in our database.</li>
<li>header.user-agent - REQUIRED - The value from the HTTP Header 'User-Agent'. This is the primary means of device detection (before <a class="el" href="_device_detection__features__u_a_c_h__overview.html">UA-CH</a> began to supplant it)</li>
<li>header.usage-from - This is not from a real HTTP header, but is added to usage data by customers in order for us to more easily identify where data is coming from. This can assist with troubleshooting problems.</li>
<li>header.host - The value from the HTTP Header 'Host'. Identifies the website that the traffic is coming from. Similar to usage-from above, this can assist with troubleshooting problems.</li>
<li>header.sec-ch-ua* - The various <a class="el" href="_device_detection__features__u_a_c_h__overview.html">UA-CH</a> headers are becoming ever more important for device detection. In order for us to be able to provide a good detection service, we require data from the real world to train our machine learning algorithm.</li>
</ul>
<p>When using our <a class="el" href="_features__web_integration.html">web integration</a> solutions, these values (with the exception of usage-from) will be added as evidence automatically. If you are not using web integration, then you will need to ensure these values are added to evidence manually. The snippet below illustrates this:</p>
<p> <div class="c-tabgroup">   <button class="b-btn b-btn--tab" onclick="showSnippet(this,'dotnet')">C#</button>   <button class="b-btn b-btn--tab" onclick="showSnippet(this,'java')">Java</button>   <button class="b-btn b-btn--tab" onclick="showSnippet(this,'node')">Node.js</button>   <button class="b-btn b-btn--tab" onclick="showSnippet(this,'php')">PHP</button>   <button class="b-btn b-btn--tab" onclick="showSnippet(this,'python')">Python</button>   <div class="c-tabgroup__main" data-lang="none" style="display:block;">  Select a tab to view language specific information on configuring <b>logging</b> </div>   <div class="c-tabgroup__main" data-lang="dotnet" style="display:none;">  </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">data.AddEvidence(“header.user-agent”, [User-Agent HTTP header])</div><div class="c-code__line">  .AddEvidence(“server.client-ip”, [source IP address of client connection])</div><div class="c-code__line">  <span class="c-code__comment">// The website root e.g. 51degrees.com</span></div><div class="c-code__line">  .AddEvidence(“header.host”, [Host HTTP header])</div><div class="c-code__line">  <span class="c-code__comment">// Provide simple name to allow 51Degrees to identify source of usage data</span></div><div class="c-code__line">  .AddEvidence(“header.usage-from”, [Business name])</div><div class="c-code__line">  <span class="c-code__comment">// Repeat for each user-agent client hints header (sec-ch-ua, sec-ch-ua-full-version-list, sec-ch-ua-platform, etc)</span></div><div class="c-code__line">  .AddEvidence(“header.sec-ch-ua-mobile”, [Sec-CH-UA-Mobile HTTP header])</div><div class="c-code__line">  .Process();</div></div><p>  </div>   <div class="c-tabgroup__main" data-lang="java" style="display:none;">  </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">data.addEvidence(“header.user-agent”, [User-Agent HTTP header])</div><div class="c-code__line">  .addEvidence(“server.client-ip”, [source IP address of client connection])</div><div class="c-code__line">  <span class="c-code__comment">// The website root e.g. 51degrees.com</span></div><div class="c-code__line">  .addEvidence(“header.host”, [Host HTTP header])</div><div class="c-code__line">  <span class="c-code__comment">// Provide simple name to allow 51Degrees to identify source of usage data</span></div><div class="c-code__line">  .addEvidence(“header.usage-from”, [Business name])</div><div class="c-code__line">  <span class="c-code__comment">// Repeat for each user-agent client hints header (sec-ch-ua, sec-ch-ua-full-version-list, sec-ch-ua-platform, etc)</span></div><div class="c-code__line">  .addEvidence(“header.sec-ch-ua-mobile”, [Sec-CH-UA-Mobile HTTP header])</div><div class="c-code__line">  .process();</div></div><p>  </div>   <div class="c-tabgroup__main" data-lang="node" style="display:none;">  </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">data.evidence.add(“header.user-agent”, [User-Agent HTTP header]);</div><div class="c-code__line">data.evidence.add(“server.client-ip”, [source IP address of client connection]);</div><div class="c-code__line">// The website root e.g. 51degrees.com</div><div class="c-code__line">data.evidence.add(“header.host”, [Host HTTP header]);</div><div class="c-code__line">// Provide simple name to allow 51Degrees to identify source of usage data</div><div class="c-code__line">data.evidence.add(“header.usage-from”, [Business name]);</div><div class="c-code__line">// Repeat for each user-agent client hints header (sec-ch-ua, sec-ch-ua-full-version-list, sec-ch-ua-platform, etc)</div><div class="c-code__line">data.evidence.add(“header.sec-ch-ua-mobile”, [Sec-CH-UA-Mobile HTTP header]);</div><div class="c-code__line">data.process();</div></div><p>  </div>   <div class="c-tabgroup__main" data-lang="php" style="display:none;">  </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">$data-&gt;evidence-&gt;set(“header.user-agent”, [User-Agent HTTP header]);</div><div class="c-code__line">$data-&gt;evidence-&gt;set(“server.client-ip” =&gt; [source IP address of client connection]);</div><div class="c-code__line"><span class="c-code__comment">// The website root e.g. 51degrees.com</span></div><div class="c-code__line">$data-&gt;evidence-&gt;set(“header.host” =&gt; [Host HTTP header]);</div><div class="c-code__line"><span class="c-code__comment">// Provide simple name to allow 51Degrees to identify source of usage data</span></div><div class="c-code__line">$data-&gt;evidence-&gt;set(“header.usage-from” =&gt; [Business name]);</div><div class="c-code__line"><span class="c-code__comment">// Repeat for each user-agent client hints header (sec-ch-ua, sec-ch-ua-full-version-list, sec-ch-ua-platform, etc)</span></div><div class="c-code__line">$data-&gt;evidence-&gt;set(“header.sec-ch-ua-mobile” =&gt; [Sec-CH-UA-Mobile HTTP header]);</div><div class="c-code__line">$data-&gt;process();</div></div><p>  </div>   <div class="c-tabgroup__main" data-lang="python" style="display:none;">  </p><div class="c-code__block c-code__block--outline"><div class="c-code__line">data.evidence.add(“header.user-agent”, [User-Agent HTTP header])</div><div class="c-code__line">data.evidence.add(“server.client-ip”, [source IP address of client connection])</div><div class="c-code__line"># The website root e.g. 51degrees.com</div><div class="c-code__line">data.evidence.add(“header.host”, [Host HTTP header])</div><div class="c-code__line"># Provide simple name to allow 51Degrees to identify source of usage data</div><div class="c-code__line">data.evidence.add(“header.usage-from”, [Business name])</div><div class="c-code__line"># Repeat for each user-agent client hints header (sec-ch-ua, sec-ch-ua-full-version-list, sec-ch-ua-platform, etc)</div><div class="c-code__line">data.evidence.add(“header.sec-ch-ua-mobile”, [Sec-CH-UA-Mobile HTTP header])</div><div class="c-code__line">data.process()</div></div><p>  </div>   </div> </p>
<h2>Share percentage</h2>
<p><b>Usage sharing</b> can be configured to only share a certain percentage of requests that pass through the <a class="el" href="_concepts__pipeline.html">Pipeline</a>. This can be useful in very high-traffic scenarios where <b>usage sharing</b> is desired, but sharing every request could put too much strain on the web server.</p>
<p>This is based on a randomized value, so the exact amount shared may not be precisely the percentage specified. For example, if generating a number between 0 and 1, the result will be above 0.5 roughly 50% of the time but it's unlikely to be exact.</p>
<h2>Timeouts</h2>
<p>There may be one or multiple configurable timeouts depending on the language. Typically, these are used to suspend <b>usage sharing</b> if its internal mechanisms are responding too slowly.</p>
<h2>Maximum queue size</h2>
<p>In languages that support multiple threads, this settings controls the size of the <a class="el" href="_features__usage_sharing.html#Internals">internal</a> producer/consumer queue.</p>
<h2>Minimum entries per message</h2>
<p>The minimum number of <a class="el" href="_concepts__data__evidence.html">evidence</a> entries that must be added before the message will be sent to the <b>usage sharing</b> web service.</p>
<h2>Repeat evidence interval</h2>
<p>The maximum time period which <a class="el" href="_concepts__data__evidence.html">evidence</a> is stored for the purpose of filtering <a class="el" href="_features__usage_sharing.html#RepeatEvidence">repeat evidence</a>.</p>
<h2>ShareUsageURL</h2>
<p>The target destination for <b>usage sharing</b> data. The default is <a href="https://devices-v4.51degrees.com/new.ashx">https://devices-v4.51degrees.com/new.ashx</a>.</p>
<p><a class="anchor" id="Low_Level_Usage_Sharing"></a><a class="el" href="_features__usage_sharing.html#Low_Level_Usage_Sharing">#</a></p>
<h1 class="g-docs__section-heading">Usage Sharing for low-level APIs</h1>
<p>The low-level device detection APIs such as C, Nginx, and Varnish do not support <b>usage sharing</b> out of the box. However, some customers using these technologies still want to share usage with us in order to help us improve the accuracy of results.</p>
<p>Our recommended approach in this situation is to have the low-level code write a log file containing the necessary evidence values from requests. This file can then be processed offline at a later date using one of the higher-level languages in order to share the data with 51Degrees.</p>
<p>The <a class="el" href="_examples__device_detection__offline_processing__on_premise_hash.html">offline processing</a> examples provide a good sample for how this might work. These take a YAML file where each record represents a request. For example:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">---</div><div class="c-code__line">header.User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 15_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.3 Mobile/15E148 Safari/604.1</div><div class="c-code__line">---</div><div class="c-code__line">header.Sec-CH-UA-Mobile: ?0</div><div class="c-code__line">header.Sec-CH-UA-Platform: &#39;&quot;Windows&quot;&#39;</div><div class="c-code__line">header.Sec-CH-UA: &#39;&quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;98&quot;, &quot;Google Chrome&quot;;v=&quot;98&quot;&#39;</div><div class="c-code__line">header.User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36</div><div class="c-code__line">...</div></div><p>You will need to modify your low-level code to output this data to a file (or memory stream, etc.). As a minimum, the values below MUST be present for each record. If not, the record will be discarded by our backend processing system.</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">header.user-agent [The value of the User-Agent HTTP header]</div><div class="c-code__line">header.host: [The value of the Host HTTP header]</div><div class="c-code__line">server.client-ip: [The source public IP that is making the request to your server]</div></div><p>The output will then need to be consumed by a process using one of the higher-level APIs. You can of course use whatever format you wish for transferring the data between your low-level code and the usage sharing process. If using the suggested YAML format and the offline processing example, the following changes will need to be made to the example:</p>
<ol type="1">
<li>Configure the input stream to take the output stream that is producing the YAML formatted data.</li>
<li>Device detection is not needed, only usage sharing, so replace the <code>DeviceDetectionPipelineBuilder</code> with <code>FiftyOnePipelineBuilder</code> and remove all the builder options that are no longer valid.</li>
<li>Configure the <code>setShareUsage</code> option to true.</li>
<li>Remove the code to get the device detection result and write an output file.</li>
</ol>
<p>This code should now be able to consume the output from the low-level code and send the usage data back to 51Degrees for analysis. </p>
</section></div><!-- PageDoc -->
</div><!-- primary -->
</div><!-- inner-->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<section id="nav-path" class="g-footer g-footer--docs"><!-- id is needed for treeview function! -->
    <p class="g-footer__copyright">Generated by
    <a href="http://www.doxygen.org/index.html">
    <b>doxygen</b></a> 1.8.15
  </p>
</section>
</div>
</main>
</div>
</body>
</html>
