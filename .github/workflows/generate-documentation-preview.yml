name: Generate Documentation Preview

on:
  pull_request:
    
jobs:
  # Generate documentation for all API repositories
  Generate_API_Documentation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell
          
      - name: Generate Documentation
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # For PR preview, we want:
          # - Documentation repo: use PR branch (head_ref)
          # - API repos: use base branch (base_ref) for stable API documentation
          
          # Get the PR branch and base branch
          PR_BRANCH="${{ github.head_ref }}"
          BASE_BRANCH="${{ github.base_ref }}"
          
          # Fallback if not in PR context
          if [ -z "$PR_BRANCH" ]; then
            PR_BRANCH="${{ github.ref_name }}"
          fi
          if [ -z "$BASE_BRANCH" ]; then
            BASE_BRANCH="${{ github.ref_name }}"
          fi
          
          echo "Documentation repo using branch: $PR_BRANCH"
          echo "API repos will use branch: $BASE_BRANCH"
          
          # Create a local branch reference so git rev-parse works correctly
          # This fixes the "HEAD" issue in GitHub Actions
          git checkout -B "$PR_BRANCH"
          
          # Set environment variable for the script to use for API repos
          export API_BRANCH="$BASE_BRANCH"
          
          # Run our custom script to generate documentation for all API repos
          pwsh ./ci/generate-documentation.ps1 -Version "4.5" -GenerateOnly
          
      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: 4.5/
          
      - name: Comment PR with artifact link
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts`;
            const comment = `ðŸ“š **Documentation Preview Generated**
            You can download the documentation artifact here:
            ðŸ”— [Download Documentation Artifact](${artifactUrl})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
