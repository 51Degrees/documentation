name: Generate Documentation Preview

on:
  pull_request:
    
jobs:
  # Generate documentation for all API repositories
  Generate_API_Documentation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell
          
      - name: Generate Documentation
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # In PR context, we want to use the head branch (source branch of PR)
          # GitHub checks out the merge commit in detached HEAD state
          BRANCH_NAME="${{ github.head_ref }}"
          if [ -z "$BRANCH_NAME" ]; then
            # Fallback if not in PR context
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          echo "Using branch: $BRANCH_NAME"
          
          # Create a local branch reference so git rev-parse works correctly
          git checkout -B "$BRANCH_NAME"
          
          # Run our custom script to generate documentation for all API repos
          pwsh ./ci/generate-documentation.ps1 -Version "4.5" -GenerateOnly
          
      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: 4.5/
          
      - name: Comment PR with artifact link
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts`;
            const comment = `ðŸ“š **Documentation Preview Generated**
            You can download the documentation artifact here:
            ðŸ”— [Download Documentation Artifact](${artifactUrl})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
